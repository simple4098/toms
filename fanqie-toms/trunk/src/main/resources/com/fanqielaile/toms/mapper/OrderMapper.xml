<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fanqielaile.toms.dao.OrderDao">
    <resultMap id="BaseResultsMap" type="com.fanqielaile.toms.model.Order">
        <id column="id" property="id"/>
        <result column="creator_id" property="creatorId"/>
        <result column="created_date" property="createdDate"/>
        <result column="updated_date" property="updatedDate"/>
        <result column="modifier_id" property="modifierId"/>
        <result column="version" property="version"/>
        <result column="deleted" property="deleted"/>
        <result column="channel_source" property="channelSource"/>
        <result column="channel_order_code" property="channelOrderCode"/>
        <result column="order_status" property="orderStatus"/>
        <result column="inn_id" property="innId"/>
        <result column="guest_name" property="guestName"/>
        <result column="room_type_id" property="roomTypeId"/>
        <result column="home_amount" property="homeAmount"/>
        <result column="live_time" property="liveTime"/>
        <result column="leave_time" property="leaveTime"/>
        <result column="total_price" property="totalPrice"/>
        <result column="prepay_price" property="prepayPrice"/>
        <result column="cost_price" property="costPrice"/>
        <result column="OTA_price" property="OTAPrice"/>
        <result column="order_time" property="orderTime"/>
        <result column="comment" property="comment"/>
        <result column="OTA_room_type_id" property="OTARoomTypeId"/>
        <result column="OTA_hotel_id" property="OTAHotelId"/>
        <result column="OTA_rate_plan_id" property="OTARatePlanId"/>
        <result column="OTA_gid" property="OTAGid"/>
        <result column="eariest_arrive_time" property="eariestArriveTime"/>
        <result column="lastest_arrive_time" property="lastestArriveTime"/>
        <result column="currency" property="currency"/>
        <result column="payment_type" property="paymentType"/>
        <result column="guest_mobile" property="guestMobile"/>
        <result column="OTA_rate_code" property="OTARateCode"/>
        <result column="fee_status" property="feeStatus"/>
        <result column="reason" property="reason"/>
        <result property="alipayTradeNo" column="alipay_trade_no"/>
        <result property="payment" column="payment"/>
        <result column="order_code" property="orderCode"/>
        <result column="company_id" property="companyId"/>
        <result column="guest_email" property="guestEmail"/>
        <result column="special_requirement" property="specialRequirement"/>
        <result column="reserved_item" property="reservedItem"/>
        <result column="fc_bed_type" property="fcBedType"/>
    </resultMap>
    <resultMap id="OrderDtoResults" type="com.fanqielaile.toms.dto.OrderParamDto">
        <id column="id" property="id"/>
        <result column="creator_id" property="creatorId"/>
        <result column="created_date" property="createdDate"/>
        <result column="updated_date" property="updatedDate"/>
        <result column="modifier_id" property="modifierId"/>
        <result column="version" property="version"/>
        <result column="deleted" property="deleted"/>
        <result column="channel_source" property="channelSource"/>
        <result column="channel_order_code" property="channelOrderCode"/>
        <result column="order_status" property="orderStatus"/>
        <result column="inn_id" property="innId"/>
        <result column="guest_name" property="guestName"/>
        <result column="room_type_id" property="roomTypeId"/>
        <result column="home_amount" property="homeAmount"/>
        <result column="live_time" property="liveTime"/>
        <result column="leave_time" property="leaveTime"/>
        <result column="total_price" property="totalPrice"/>
        <result column="prepay_price" property="prepayPrice"/>
        <result column="cost_price" property="costPrice"/>
        <result column="OTA_price" property="OTAPrice"/>
        <result column="order_time" property="orderTime"/>
        <result column="comment" property="comment"/>
        <result column="OTA_room_type_id" property="OTARoomTypeId"/>
        <result column="OTA_hotel_id" property="OTAHotelId"/>
        <result column="OTA_rate_plan_id" property="OTARatePlanId"/>
        <result column="OTA_gid" property="OTAGid"/>
        <result column="eariest_arrive_time" property="eariestArriveTime"/>
        <result column="lastest_arrive_time" property="lastestArriveTime"/>
        <result column="currency" property="currency"/>
        <result column="payment_type" property="paymentType"/>
        <result column="guest_mobile" property="guestMobile"/>
        <result column="OTA_rate_code" property="OTARateCode"/>
        <result column="fee_status" property="feeStatus"/>
        <result column="reason" property="reason"/>
        <result property="alipayTradeNo" column="alipay_trade_no"/>
        <result property="payment" column="payment"/>
        <result column="inn_name" property="innName"/>
        <result column="company_id" property="companyId"/>
        <result column="guest_email" property="guestEmail"/>
        <result column="special_requirement" property="specialRequirement"/>
        <result column="reserved_item" property="reservedItem"/>
        <result column="fc_bed_type" property="fcBedType"/>

    </resultMap>
    <sql id="Base_Column_List">
              id, creator_id, created_date, updated_date,modifier_id,version,deleted,channel_source,channel_order_code,order_status,inn_id,guest_name,room_type_id,home_amount,live_time,leave_time,
        total_price,prepay_price,cost_price,OTA_price,order_time,comment,OTA_room_type_id,OTA_hotel_id,OTA_rate_plan_id,OTA_gid,eariest_arrive_time,lastest_arrive_time,currency,payment_type,
        guest_mobile,OTA_rate_code,fee_status,reason,alipay_trade_no,payment,order_code,company_id,payment,guest_email,special_requirement,reserved_item,fc_bed_type
       </sql>
    <insert id="insertOrder" parameterType="com.fanqielaile.toms.model.Order">
              INSERT INTO ota_toms_order(id, creator_id, created_date, updated_date,modifier_id,version,deleted,channel_source,channel_order_code,order_status,inn_id,guest_name,room_type_id,home_amount,
        live_time,leave_time,total_price,prepay_price,cost_price,OTA_price,order_time,comment,OTA_room_type_id,OTA_hotel_id,OTA_rate_plan_id,OTA_gid,eariest_arrive_time,lastest_arrive_time,
        currency,payment_type,guest_mobile,OTA_rate_code,fee_status,order_code,company_id,payment,guest_email,special_requirement,reserved_item,fc_bed_type)
              VALUES
        (#{id},#{creatorId},#{createdDate},#{updatedDate},#{modifierId},#{version},#{deleted},#{channelSource},#{channelOrderCode},#{orderStatus},#{innId},#{guestName},#{roomTypeId},#{homeAmount},
        #{liveTime},#{leaveTime},#{totalPrice},#{prepayPrice},#{costPrice},#{OTAPrice},#{orderTime},#{comment},#{OTARoomTypeId},#{OTAHotelId},#{OTARatePlanId},#{OTAGid},#{eariestArriveTime},
        #{lastestArriveTime},#{currency},#{paymentType},#{guestMobile},#{OTARateCode},#{feeStatus},#{orderCode},#{companyId},#{payment},#{guestEmail},#{specialRequirement},
        #{reservedItem},#{fcBedType})
       </insert>
    <select id="selectOrderByChannelSourceAndOrderId" resultMap="BaseResultsMap">
        SELECT
        <include refid="Base_Column_List"/>
        from ota_toms_order where deleted = 0 and channel_source = #{channelSource} and channel_order_code =
        #{channelOrderCode} limit 1
    </select>
    <select id="selectOrderByIdAndChannelSource" resultMap="BaseResultsMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM ota_toms_order where deleted = 0 and channel_source = #{channelSource} and id = #{orderId} limit 1
    </select>
    <update id="updateOrderStatusAndReason" parameterType="com.fanqielaile.toms.model.Order">
        UPDATE ota_toms_order set order_status = #{orderStatus} , reason = #{reason},updated_date=now() where deleted =
        0 and id=#{id}
    </update>
    <update id="updateOrderStatusAndFeeStatus" parameterType="com.fanqielaile.toms.model.Order">
        UPDATE ota_toms_order set order_status=#{orderStatus} , fee_status = #{feeStatus},payment = #{payment}
        ,alipay_trade_no = #{alipayTradeNo},updated_date = now() where deleted = 0 and id=#{id}
    </update>
    <select id="selectOrderByPage" resultMap="OrderDtoResults">
        SELECT oto.*,bi.inn_name as inn_name from ota_toms_order oto
        LEFT JOIN bang_inn bi on oto.inn_id = bi.inn_id and oto.company_id = bi.company_id
        <where>
            <if test="order.orderStatusString != null and order.orderStatusString =='DEAL'">
                AND oto.order_status !='NOT_DEAL' AND oto.order_status != 'PAY_BACK'
            </if>
            <if test="order.orderStatusString != null and order.orderStatusString =='NOT_DEAL'">
                AND oto.order_status ='NOT_DEAL'
            </if>
            <if test="companyId != null and companyId != ''">
                and oto.company_id=#{companyId}
            </if>
            <if test="order.orderStatus != null and order.orderStatus != ''">
                and oto.order_status = '${order.orderStatus}'
            </if>
            <if test="order.channelSource != null and order.channelSource != ''">
                and oto.channel_source = '${order.channelSource}'
            </if>
            <if test="order.searchType != null and order.searchType != ''">
                and oto.${order.searchType} BETWEEN '${order.beginDate}' and '${order.endDate}'
            </if>
            <if test="order.channelOrderCode != null and order.channelOrderCode != ''">
                and oto.channel_order_code = '${order.channelOrderCode}'
            </if>
        </where>
        ORDER BY oto.order_time DESC
    </select>
    <select id="selectOrders" resultMap="OrderDtoResults">
        SELECT oto.*,bi.inn_name as inn_name from ota_toms_order oto
        LEFT JOIN bang_inn bi on oto.inn_id = bi.inn_id and oto.company_id = bi.company_id
        LEFT JOIN company c on oto.company_id = c.id
        <where>
            <if test="companyId != null and companyId != ''">
                and c.id=#{companyId}
            </if>
            <if test="order.searchType != null and order.searchType != ''">
                <if test="order.beginDate != null and order.beginDate != '' ">
                    <if test="order.endDate != null and order.endDate != ''">
                        and oto.${order.searchType} BETWEEN '${order.beginDate}' and '${order.endDate}'
                    </if>
                </if>
            </if>
        </where>
    </select>

    <select id="selectOrderById" parameterType="java.lang.String" resultMap="OrderDtoResults">
        SELECT oto.*,bi.inn_name as inn_name from ota_toms_order oto
        LEFT JOIN bang_inn bi on oto.inn_id = bi.inn_id and oto.company_id = bi.company_id
        LEFT JOIN company c on bi.company_id = c.id
        <where>
            <if test="id != null and id != ''">
                and oto.id=#{id}
            </if>
        </where>
    </select>
    <select id="selectOrderChancelSource" resultMap="BaseResultsMap" parameterType="java.lang.String">
        SELECT channel_source from ota_toms_order WHERE company_id = #{companyId} GROUP BY channel_source
    </select>
</mapper>